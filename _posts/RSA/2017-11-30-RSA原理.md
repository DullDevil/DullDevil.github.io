---
title: iOS 数据加密：RSA 原理
categories: [数据加密]
MathJax: true
---

- TOC
{:toc}



## 1、RSA 密钥生成
一对 RSA 密钥有三个值组成：e， d， n。 n 和 e 组成公钥（n，e），n 和 e 组成私钥（n，e）。生成密钥对的过程就是计算出 e，d，n 的过程。

### 1、需要随机选择两个不相等的质数[^1] p 和 q。

```
p = 61
q = 53
```

### 2、计算p和q的乘积n。

```
n = p * q = 61 * 53 = 3233;
```

n的长度就是密钥长度。3233写成二进制是110010100001，一共有12位，所以这个密钥就是12位。实际应用中，RSA密钥一般是1024位，重要场合则为2048位。

### 3、计算n的欧拉函数φ(n)。

任意给定正整数n，计算在小于等于n的正整数之中，有多少个与n构成互质关系？计算这个值的方法就叫做欧拉函数，以φ(n)表示。

欧拉函数中有这样几个个定理：  

如果n可以分解成两个互质的整数之积，即 n = p×q，则有：φ(n) = φ(pq) = φ(p)φ(q); 比如

```
φ(21) = φ(3 * 7) = φ(3) * φ(7) = 2 * 6 = 12；
21 : 20 19 17 16  13 11 10 8  5 4 2 1
```

质数与小于它的每一个数，都构成互质关系，记做φ(n) = n - 1。比如

```
φ(5) = 5 - 1 = 4
5 : 1 2 3 4
```



所以可以得出

```
φ(3233) = φ(61 * 53) = φ(61) * φ(53) = (61 - 1) * (53 - 1) = 60 * 52 = 3120
```


### 4、随机选择一个整数e，条件是1< e < φ(n)，且e与φ(n) 互质

这里就选一个 19 ；即 e = 19；（实际应用中，常常选择65537。）


### 5、计算e对于φ(n)的模反元素d

所谓"模反元素"就是指有一个整数d，可以使得ed被φ(n)除的余数为1。

```
e * d ≡ 1 (mod φ(n))
```

转换之后可得：

```
e * d - 1 = k * φ(n)

19 * d - 3120 * k = 1; （d 和 k 都为整数）

```

求的一组解为 d = 2299； k = 19

### 6、组装密钥对

公钥 ： (3233,19)

私钥 ： (3233,2299)


## 2、加解密运算

现在已经获取到了密钥对，现在就可以进行加解密运算了

### 1、公钥加密
现在有明文数据 m (123)，需要用公钥 (n,e) 加密，就是算出下式的c：

$$ m^e \ ≡ \ c \ ( \ mod \ n \ ) $$

$$ 123^{19} \ ≡ \ c \ ( \ mod \ 3233 \ ) $$

$$ c \ = \ 123^{19}  \ mod \ 3233  $$

加密得到密文 c = 62


### 2、私钥解密
现在有密文数据 c (62)，需要用私钥钥 (n,d) 解密，就是算出下式的m：

$$ c^d \ ≡ \ m \ ( \ mod \ n \ ) $$

$$ 62^{2299} \ ≡ \ m \ ( \ mod \ 3233 \ ) $$

$$ m \ = \ 62^{2299}  \ mod \ 3233  $$

解密得到明文 m = 123


### 3、私钥加密
现在有明文数据 m (123)，需要用私钥 (n,d) 加密，就是算出下式的c：

$$ m^d \ ≡ \ c \ ( \ mod \ n \ ) $$

$$ 123^{2299} \ ≡ \ m \ ( \ mod \ 3233 \ ) $$

$$ c \ = \ 123^{2299}  \ mod \ 3233  $$

加密得到密文 c = 2502

### 4、公钥解密
现在有密文数据 c (2502)，需要用公钥 (n,e) 解密，就是算出下式的m：

$$ c^e \ ≡ \ m \ ( \ mod \ n \ ) $$

$$ 2502^{19} \ ≡ \ m \ ( \ mod \ 3233 \ ) $$

$$ m \ = \ 2502^{19}  \ mod \ 3233  $$


解密得到明文 m = 123

## 1、原理验证

### 1、公钥加密私钥解密

加解密的公式如下

$ c^d \ ≡ \ m \ (\ mod\ n) $

$ m^e ≡ c\ (\ mod\ n ) ==> c = m^e - kn $

替换加密公式中的 c 所以得到:

$ (m^e - kn)^d ≡ m\ (\ mod\ n ) $

将左边的式子展开之后，除了第一项 $m^{ed}$，其他的每一项都能被 n 整除

所以求证等同于 $ m^{ed} ≡ m\ (\ mod\ n) $

由于 $ ed ≡ 1 (\ mod\ φ(n)) $

所以 $ed  = 1 + hφ(n)$

则 $ m^{ed} ≡ m\ (\ mod\ n) $ 可转换为：

$$ m^{(1+hφ(n))} ≡ m\ (\ mod\ n ) $$

所以只需要证明上面这个成立即可。

---

m 与 n 可分两种情况：

#### 1、如果 m 与 n 互质

则由欧拉定理[^2]$ m^{φ(n)} ≡ 1\ (\ mod\ n ) $得

$$ m^{hφ(n)} * m ≡ m\ (\ mod\ n ) $$

即

$$ m^{(1+hφ(n))} ≡ m\ (\ mod\ n ) $$


#### 2、如果 m 与 n 不是互质关系。

由于n等于质数 p 和 q 的乘积，所以 m 必然等于 kp 或 kq 。

取 m = kp，由于 m < n，所以 k < q。因为 q 为质数，所以 k 与 q 必然互质。又因为 p 与 q也互质，

所以 kp 与 q 也互质，得：

$$ {(kp)}^{q-1} ≡ 1\ (\ mod\ q ) $$

两边乘以 kp ,再做升幂得：

$ {[{(kp)}^{q-1}]}^{h(p-1)} * kp ≡ kp\ (\ mod\ q ) $

$ {(kp)}^{h(q-1)(p-1) + 1}  ≡ kp\ (\ mod\ q ) $

$ {(kp)}^{ 1 + hφ(n)}  ≡ kp\ (\ mod\ q ) $

$$ {(kp)}^{ed}  ≡ kp\ (\ mod\ q ) $$

转换之后为：

$ {(kp)}^{ed}  = tq + kp $

$ {(kp)}^{ed}  = \frac{t}{p}qp + kp $

$$ {(kp)}^{ed}  = \frac{t}{p}n + kp $$

因为 kp = m，所以

$$ {m}^{(1+hφ(n))}  = \frac{t}{p}n + m $$


又因为 ：

$ tq = {(kp)}^{ed} - kp $

$ tq = {(kp)}^{ed-1} $

$ tq = {(kp)}^{ed-1} $

$ \frac{t}{p}qp = {(kp)}^{ed-1}$

所以

$$ \frac{t}{p} ∈ Z $$

可得


$$ m^{(1+hφ(n))} ≡ m\ (\ mod\ n ) $$


**综合 1、2 两种情况 可以验证 $ m^{(1+hφ(n))} ≡ m\ (\ mod\ n ) $ 是成立的。**


### 2、私钥加密公钥解密

加解密的公式如下

$ c^e \ ≡ \ m \ (\ mod\ n) $

$ m^d ≡ c\ (\ mod\ n ) ==> c = m^d - kn $

替换加密公式中的 c 所以得到:

$ (m^d - kn)^e ≡ m\ (\ mod\ n ) $

将左边的式子展开之后，除了第一项 $m^{ed}$，其他的每一项都能被 n 整除

所以求证等同于 $ m^{ed} ≡ m\ (\ mod\ n) $

这里要验证的式子跟公钥加密私钥解密要验证的一样，所以私钥加密公钥解密也是可行的。








---

参考链接：[RSA算法原理（二）](http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html)

[^1]:质数又称素数。一个大于1的自然数，除了1和它自身外，不能被其他自然数整除的数叫做质数；否则称为合数。
[^2]:如果两个正整数a和n互质，则n的欧拉函数 φ(n) 可以让下面的等式成立：$a^{φ(n)} = 1\ (\ mod\ n)$
